From: Kyle J. McKay <mackyle@gmail.com>
Subject: [PATCH] pcreposix: add REG_PEND support

The REG_PEND regcomp() option allows the pattern string to
consist of arbitrary bytes (i.e. not necessarily NUL terminated
and possibly containing embedded NUL bytes).

This is a BSDism, but since it's not too horribly difficult to
implement and it improves regex.h compatibility go ahead and
implement it.

To implement this the following changes are effected:

1. A new PCRE_ALLOW_EMBEDDED_NUL option is provided.

   This only provides part of the support in that while
   it allows embedded NULs (they are lexically treated as
   \000 literal code point matches both inside and
   outside of character classes only), it still requires
   the pattern to have a terminating NUL.

   Secondly this option provides a means to pass the
   pattern in as a starting pointer and an ending pointer
   which MUST be >= the staring pointer and MUST point to
   a NUL byte if it's > the starting pointer.  If not, a
   bad options error (ERR17) is immediately returned.

   Look at the code to see how this is accomplished
   without altering the function signatures.  Be warned
   though that your eyes might POP RIGHT OUT OF YOUR HEAD
   when you look at it!  ;)

2. The BSDish REG_PEND option is provided that works as
   follows:

   If the re_endp pointer is less than the pattern pointer
   an immediate REG_INVARG error is returned.

   Note that PCRE's ERR17 is also translated by pcreposix
   to a REG_INVARG error.  This is not a coincidence.

   Otherwise a malloc'd buffer of re_endp-pattern+1 bytes
   is allocated, the last byte is set to NUL and the
   PCRE_ALLOW_EMBEDDED_NUL option is passed.  The buffer
   is immediately freed after the compile call since any
   error offets are still valid for the original, uncopied
   pattern.

   Except, the following two optimizations are done to avoid
   needing to make a malloc'd + NUL copy in some cases:

    1. if pattern == re_endp then a static "" string is passed
       and the REG_PEND option is ignored.

    2. if re_endp and (re_endp - 1) are in the same 1K page
       then *re_endp is checked and if it's already a NUL
       then no copy is made.  This should be safe on all
       platforms regardless of any memory protection settings.

Note: This patch is licensed under the same terms as PCRE itself.

Signed-off-by: Kyle J. McKay <mackyle@gmail.com>
